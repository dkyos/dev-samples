// ./gradlew -q -Pprofile=mobile test1
// ./gradlew -q -Pprofile=wearable test1
// ./gradlew -q -Pprofile=tv test1

import org.apache.tools.ant.taskdefs.condition.Os

defaultTasks 'checkWin'

task checkWin() {
	def CMD_PATH='';
	String Profile;

	println ("================================");
	if (Os.isFamily(Os.FAMILY_WINDOWS)) {
		println "*** Windows";
		CMD_PATH='C:/tizen-sdk/tools/ide/bin/tizen.bat';
	}else{
		println "*** Not Windwos";
		CMD_PATH='/home/dkyun77/tizen-sdk/tools/ide/bin/tizen';
	}

	project.ext.set("tizenPath", "${CMD_PATH}");
	println (" tizen: " + project.tizenPath);

	if( project.hasProperty("profile")) {
		Profile = "${profile}".toString();
	}else{
		Profile = "mobile";
	}
	project.ext.set("profile", Profile);
	println (" profile: " + project.profile);

	println ("================================");
}

task build_native(dependsOn: checkWin) << {
	def CMD = project.tizenPath;
	def sout = new StringBuilder();
	def serr = new StringBuilder();
	def sout2 = new StringBuilder();
	def serr2 = new StringBuilder();
	def PLATFORM;
	def TEMPLATE;
	def NAME;

	println ("================================");
	def process = ["${CMD}","list", "native-project"].execute();
	process.consumeProcessOutput(sout, serr);
	process.waitFor();
	println ("Exit value: " + process.exitValue());
	//println "$sout"; println "$serr";

	sout.eachLine { line, count ->
		//println ("line $count: $line"); 

		if (line.contains(project.profile) ){
			String[] splited = line.split("\\s+");
			PLATFORM = splited[0];
			TEMPLATE = splited[1];
			NAME = splited[1].replaceAll('_','');
			NAME = NAME.replaceAll('-','');

			// create
			process = ["${CMD}", "create", "native-project"
				, "-p", "${PLATFORM}" , "-t", "${TEMPLATE}" , "-n", "${NAME}"
				, "--", "${PLATFORM}"].execute();
			process.consumeProcessOutput(sout2, serr2);
			process.waitFor();
			println "$sout2"; println "$serr";
			sout2.delete(0, sout2.length()); serr2.delete(0, serr2.length());

			// build
			process = ["${CMD}", "build-native"
				, "--arch", "x86" , "--compiler", "llvm" , "--configuration", "Debug"
				, "--", "${PLATFORM}/${NAME}"].execute();
			process.consumeProcessOutput(sout2, serr2);
			process.waitFor();
			println "$sout2"; println "$serr";
			sout2.delete(0, sout2.length()); serr2.delete(0, serr2.length());
		}
	}

	println ("================================");
}

task package_native(dependsOn: checkWin) << {
	def CMD = project.tizenPath;
	def sout = new StringBuilder();
	def serr = new StringBuilder();
	def sout2 = new StringBuilder();
	def serr2 = new StringBuilder();
	def PLATFORM;
	def TEMPLATE;
	def NAME;

	println ("================================");
	def process = ["${CMD}","list", "native-project"].execute();
	process.consumeProcessOutput(sout, serr);
	process.waitFor();
	println ("Exit value: " + process.exitValue());
	//println "$sout"; println "$serr";

	sout.eachLine { line, count ->
		//println ("line $count: $line"); 

		if (line.contains(project.profile) ){
			String[] splited = line.split("\\s+");
			PLATFORM = splited[0];
			TEMPLATE = splited[1];
			NAME = splited[1].replaceAll('_','');
			NAME = NAME.replaceAll('-','');

			// pacage
			process = ["${CMD}", "package"
				, "--type", "tpk"
				, "--", "${PLATFORM}/${NAME}/Debug"].execute();
			process.consumeProcessOutput(sout2, serr2);
			process.waitFor();
			println "$sout2"; println "$serr";
			sout2.delete(0, sout2.length()); serr2.delete(0, serr2.length());
		}
	}

	println ("================================");
}

task test1(dependsOn: checkWin) << {
	tasks["build_native"].execute();
	tasks["package_native"].execute();
}

